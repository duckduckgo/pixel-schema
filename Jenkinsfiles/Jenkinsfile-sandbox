pipeline {
    agent { label 'ubuntu-latest' }
    triggers { cron('H H * * *') }
   stages {
        stage('Cleanup'){
             steps {
                sh '''#!/bin/bash
                    ls
                '''
            }
        }
        stage('clone pixel-schema repo ') {
            steps {
                dir('pixel-schema') {
                    checkout([$class: 'GitSCM', branches: [[name: "jmatthews/automate_live_validation_alerts"]],
                    extensions: [[$class: 'LocalBranch']],
                    userRemoteConfigs: [[url: 'https://github.com/duckduckgo/pixel-schema.git']]])
                }
            }
        }
        stage('clone duckduckgo-privacy-extension repo ') {
            steps {
                dir('duckduckgo-privacy-extension') {
                    checkout([$class: 'GitSCM', branches: [[name: "main"]],
                    extensions: [[$class: 'LocalBranch']],
                    userRemoteConfigs: [[url: 'https://github.com/duckduckgo/duckduckgo-privacy-extension.git']]])
                }
            }
        }
        stage('clone windows-browser repo with credentials') {
            steps {
                dir('windows-browser') {
                    checkout([$class: 'GitSCM', branches: [[name: "jmatthews/automate-pixel-validation"]],
                    extensions: [[$class: 'LocalBranch']],
                    userRemoteConfigs: [[credentialsId: 'windows-browser-rw', url: 'https://github.com/duckduckgo/windows-browser.git']]])
                }
            }
        }
        stage('Validate pixels for duckduckgo-privacy-extension'){
             steps {
                sh '''#!/bin/bash
                    ls duckduckgo-privacy-extension/pixel-definitions/
                    DATE=`date --rfc-3339=seconds | sed -e 's/ /-/g'`
                    echo $DATE
                    cd pixel-schema
                    fnm install
                    fnm exec npm ci
                    echo "Preprocess defs"
                    fnm exec npm run preprocess-defs ../duckduckgo-privacy-extension/pixel-definitions/.
                    echo "Fetch Clickhouse"
                    fnm exec npm run fetch-clickhouse-data ../duckduckgo-privacy-extension/pixel-definitions/
                    echo "Validate pixels"
                    fnm exec npm run validate-live-pixels ../duckduckgo-privacy-extension/pixel-definitions/ >  /tmp/${DATE}.txt
                    echo "UNIQUE ERROR PIXELS duckduckgo-privacy-extension"
                    ls -al ../duckduckgo-privacy-extension/pixel-definitions/pixel_processing_results/pixel_errors.json 
                    cat ../duckduckgo-privacy-extension/pixel-definitions/pixel_processing_results/pixel_errors.json >>  /tmp/${DATE}.txt
                    ddg-perl /usr/local/ddg/sysadmin/scripts/asana_create_task.pl \
                            --attachment /tmp/${DATE}.txt \
                            --assignee jmatthews@duckduckgo.com \
                            --description "Pixel validation report: duckduckgo-privacy-extension ${DATE}" \
                            --project_id 1210584574754345 \
                            --no_duplicates \
                            "Pixel validation report: duckduckgo-privacy-extension ${DATE}"
                    rm /tmp/${DATE}.txt 
                    rm /tmp/live_pixels.csv 
                    cd ..
                '''
            }
        }
        stage('Validate pixels for windows-browser'){
             steps {
                sh '''#!/bin/bash
                    ls windows-browser/PixelDefinitions/
                    DATE=`date --rfc-3339=seconds | sed -e 's/ /-/g'`
                    echo $DATE
                    cd pixel-schema
                    fnm install
                    fnm exec npm ci
                    echo "Preprocess defs"
                    fnm exec npm run preprocess-defs ../windows-browser/PixelDefinitions/.
                    echo "Fetch Clickhouse"
                    fnm exec npm run fetch-clickhouse-data ../windows-browser/PixelDefinitions/
                    echo "Validate pixels"
                    fnm exec npm run validate-live-pixels ../windows-browser/PixelDefinitions/ >  /tmp/${DATE}.txt
                    echo "UNIQUE ERROR PIXELS windows-browser"
                    ls -al ../windows-browser/PixelDefinitions/pixel_processing_results/pixel_errors.json
                    cat ../windows-browser/PixelDefinitions/pixel_processing_results/pixel_errors.json >>  /tmp/${DATE}.txt
                    
                    ddg-perl /usr/local/ddg/sysadmin/scripts/asana_create_task.pl \
                            --attachment /tmp/${DATE}.txt \
                            --assignee jmatthews@duckduckgo.com \
                            --description "Pixel validation report: windows-browser ${DATE}" \
                            --project_id 1210584574754345 \
                            --no_duplicates \
                            "Pixel validation report: windows-browser ${DATE}"
                    rm /tmp/${DATE}.txt
                    rm /tmp/live_pixels.csv 
                    cd ..
                '''
            }
        }
    }
    post {
        failure {
            sh '''#!/bin/bash
                source /etc/profile.d/perlbrew.sh
                export PERL5LIB=/usr/local/ddg/lib:$PERL5LIB  # /usr/local/ddg repo
                /usr/local/ddg/sysadmin/scripts/asana_create_task.pl \
                    --assignee jmatthews@duckduckgo.com \
                    --description "Jenkins pixel validation failed" \
                    --project_id 1210585418929080 \
                    --no_duplicates \
                    "pixel validation failed"
            '''
        }
    }
}