pipeline {
    agent { label 'ubuntu-latest' }
    environment {
        USER_MAP="../internal-github-asana-utils/user_map.yml"
    }
    stages {
        stage('Setup parameters') {
            steps {
                script {
                    properties([
                        parameters([
                            choice(
                                choices: ['Android', 'Apple-iOS', 'Apple-macOS', 'Extension', 'Windows'],
                                description: 'The client to validate',
                                name: 'CLIENT_REPO'
                            ),
                            string(
                                defaultValue: 'main',
                                description: 'Client Branch',
                                name: 'CLIENT_BRANCH'
                            ),
                            string(
                                defaultValue: '',
                                description: 'Pixel prefix to match against with LIKE operator',
                                name: 'PIXEL_PREFIX'
                            ),
                            string(
                                defaultValue: 'main',
                                description: 'Pixel Schema Branch',
                                name: 'PIXEL_SCHEMA_BRANCH'
                            )
                        ])
                    ])

                }
            }
        }
        stage('clone pixel-schema repo ') {
            steps {
                dir('pixel-schema') {
                    checkout([$class: 'GitSCM', branches: [[name: "${params.PIXEL_SCHEMA_BRANCH}"]],
                    extensions: [[$class: 'LocalBranch']],
                    userRemoteConfigs: [[url: 'https://github.com/duckduckgo/pixel-schema.git']]])
                }
            }
        }
        stage('clone client repo ') {
            steps {
                script {
                    def repoMap = [
                        Android   : 'android',
                        'Apple-iOS': 'apple-browsers',
                        'Apple-macOS': 'apple-browsers',
                        Extension : 'duckduckgo-privacy-extension',
                        Windows   : 'windows-browser',
                    ]
                    def clientRepo = repoMap[params.CLIENT_REPO]
                    if (!clientRepo) {
                        error("Unknown CLIENT_REPO: ${params.CLIENT_REPO}")
                    }

                    echo "Client repo: ${clientRepo}"

                    dir('client-repo') {
                        checkout([$class: 'GitSCM', branches: [[name: "${params.CLIENT_BRANCH}"]],
                            extensions: [[$class: 'LocalBranch']],
                            userRemoteConfigs: [[credentialsId: 'windows-browser-rw', url: "https://github.com/duckduckgo/${clientRepo}.git"]]] )
                    }
                }
            }
        }
        stage('clone internal-github-asana-utils repo ') {
            steps {
                dir('internal-github-asana-utils') {
                    checkout([$class: 'GitSCM', branches: [[name: "main"]],
                    extensions: [[$class: 'LocalBranch']],
                    userRemoteConfigs: [[credentialsId: 'windows-browser-rw', url: 'https://github.com/duckduckgo/internal-github-asana-utils.git']]])
                }
            }
        }
        stage('Install ') {
             steps {
                sh '''#!/bin/bash
                    cd pixel-schema
                    fnm install
                    fnm exec npm ci
                    cd ..
                '''
            }
        }
        stage('Confirm settings ') {
             steps {
                sh '''#!/bin/bash
                    echo "User map: $USER_MAP"
                '''
            }
        }
        stage('Validate pixels'){
             steps {
                script {
                    def pixelsDir = params.CLIENT_REPO == 'Extension' ? 'pixel-definitions' : 'PixelDefinitions'
                    echo "Pixels dir: ${pixelsDir}"
                    def result = withEnv([
                        "MAIN_DIR=../client-repo/${pixelsDir}/",
                        "PIXEL_PREFIX=${params.PIXEL_PREFIX}"
                    ]) {
                        sh(
                            script: '''#!/bin/bash
                                cd pixel-schema
                                echo "Starting validation in $MAIN_DIR with pixel prefix $PIXEL_PREFIX ..."
                                fnm exec npm run preprocess-defs $MAIN_DIR
                                fnm exec npm run fetch-clickhouse-data $MAIN_DIR $PIXEL_PREFIX
                                fnm exec npm run validate-live-pixels $MAIN_DIR $CSV_FILE
                                exit_code=$?
                                echo "validateRepo.sh exit code: $exit_code"
                                echo -e "\n*** VALIDATION RESULTS: undocumented pixels ***"
                                if [[ -f $MAIN_DIR/wide_events ]]; then
                                    cat $MAIN_DIR/pixels/pixel_processing_results/undocumented_pixels.json
                                else
                                    cat $MAIN_DIR/pixel_processing_results/undocumented_pixels.json
                                fi
                                echo -e "\n*** VALIDATION RESULTS: pixel errors ***"
                                if [[ -f $MAIN_DIR/wide_events ]]; then
                                    cat $MAIN_DIR/pixels/pixel_processing_results/pixel_errors.json
                                else
                                    cat $MAIN_DIR/pixel_processing_results/pixel_errors.json
                                fi
                                cd ..
                                exit $exit_code
                            ''',
                            returnStatus: true
                        )
                    }
                    if (result != 0) {
                        echo "WARNING: validateRepo.sh failed with exit code: ${result}"
                        error("Validation failed")
                    }
                }
            }
        }
    }
}